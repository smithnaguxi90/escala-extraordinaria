<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Escala Pro 2026 | Enterprise</title>
    <meta name="description" content="Gestão de Escala Profissional 2026" />

    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- PDF Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Favicon & Apple Touch Icon (Dinâmicos) -->
    <link
      id="faviconLink"
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%232563eb%22/><path stroke=%22white%22 stroke-width=%228%22 stroke-linecap=%22round%22 fill=%22none%22 d=%22M20 30h60v50H20zM35 15v25M65 15v25M20 50h60%22/></svg>"
    />
    <link
      id="appleIconLink"
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%232563eb%22/><path stroke=%22white%22 stroke-width=%228%22 stroke-linecap=%22round%22 fill=%22none%22 d=%22M20 30h60v50H20zM35 15v25M65 15v25M20 50h60%22/></svg>"
    />

    <style>
      /* --- VARIÁVEIS CSS (THEMING) --- */
      :root {
        /* CORES MODO CLARO (Acessibilidade: Contraste Alto) */
        --primary: #2563eb; /* Azul mais forte para leitura em branco */
        --primary-dark: #1d4ed8;
        --primary-light: #eff6ff;

        --bg-body: #f1f5f9; /* Slate 100 - Pouco mais escuro que branco puro para conforto */
        --bg-surface: #ffffff;
        --bg-hover: #e2e8f0;

        --text-main: #0f172a; /* Slate 900 - Quase preto */
        --text-muted: #475569; /* Slate 600 - Cinza médio/escuro */
        --border: #cbd5e1; /* Slate 300 - Bordas mais visíveis */

        --success: #16a34a; /* Green 600 - Verde mais escuro para texto */
        --warning: #d97706; /* Amber 600 - Laranja mais escuro */
        --danger: #dc2626; /* Red 600 - Vermelho mais escuro */

        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --radius: 12px;
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      [data-theme="dark"] {
        /* CORES MODO ESCURO (Acessibilidade: Brilho Suave) */
        --bg-body: #020617; /* Slate 950 - Fundo bem escuro */
        --bg-surface: #0f172a; /* Slate 900 - Superfícies */
        --bg-hover: #1e293b; /* Slate 800 */

        --text-main: #f8fafc; /* Slate 50 - Branco suave */
        --text-muted: #cbd5e1; /* Slate 300 - Cinza claro */
        --border: #334155; /* Slate 700 */

        --primary: #60a5fa; /* Blue 400 - Azul mais claro para brilhar no escuro */
        --primary-dark: #3b82f6;
        --primary-light: rgba(59, 130, 246, 0.15);

        --success: #4ade80; /* Green 400 - Verde claro */
        --warning: #fbbf24; /* Amber 400 - Amarelo claro */
        --danger: #f87171; /* Red 400 - Vermelho claro */

        --shadow-sm: none;
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.5);
      }

      /* --- RESET & BASE --- */
      * {
        box-sizing: border-box;
        outline: none;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        line-height: 1.6;
        scroll-behavior: smooth;
        transition: background-color 0.3s, color 0.3s;
      }

      /* --- LAYOUT --- */
      .app-layout {
        display: grid;
        grid-template-rows: auto 1fr;
        min-height: 100vh;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* --- HEADER --- */
      .top-nav {
        background: var(--bg-surface);
        border-bottom: 1px solid var(--border);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      .brand:hover {
        opacity: 0.7;
      }
      .brand-icon {
        width: 40px;
        height: 40px;
        background: var(--primary);
        color: white;
        border-radius: 10px;
        display: grid;
        place-items: center;
        font-weight: 700;
        font-size: 1.2rem;
      }
      [data-theme="dark"] .brand-icon {
        color: #0f172a; /* Texto escuro no ícone claro em dark mode */
      }

      .brand-info h1 {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.5px;
      }
      .brand-info span {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      .nav-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      /* --- BUTTONS --- */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        border: 1px solid transparent;
        background: transparent;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }
      [data-theme="dark"] .btn-primary {
        color: #0f172a; /* Texto escuro para contraste no botão claro */
        font-weight: 600;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: var(--bg-surface);
        border-color: var(--border);
        color: var(--text-main);
      }
      .btn-secondary:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: var(--bg-hover);
      }

      .btn-icon {
        padding: 8px;
        border-radius: 50%;
        color: var(--text-muted);
      }
      .btn-icon:hover {
        background: var(--bg-hover);
        color: var(--text-main);
      }

      /* --- BACK TO TOP BUTTON --- */
      .btn-back-to-top {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transform: translateY(20px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 90;
      }
      [data-theme="dark"] .btn-back-to-top {
        color: #0f172a;
      }
      .btn-back-to-top.visible {
        opacity: 1;
        pointer-events: all;
        transform: translateY(0);
      }
      .btn-back-to-top:hover {
        background: var(--primary-dark);
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
      }

      /* --- DASHBOARD --- */
      .dashboard {
        padding: 2rem;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 24px;
      }

      /* SIDEBAR */
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .card {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
      }

      .stats-header {
        font-size: 0.875rem;
        font-weight: 700; /* Mais bold para acessibilidade */
        color: var(--text-muted);
        margin-bottom: 1rem;
        text-transform: uppercase;
        display: flex;
        justify-content: space-between;
        align-items: center;
        letter-spacing: 0.5px;
      }

      .stat-item {
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }
      .stat-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 0.95rem; /* Texto levemente maior */
        font-weight: 500;
      }

      .stat-value {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--success);
        font-weight: 600;
        margin-top: 4px;
        opacity: 0;
        height: 0;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .stat-value.visible {
        opacity: 1;
        height: auto;
        margin-top: 8px;
      }

      .progress-bg {
        height: 10px; /* Barra mais grossa */
        background: var(--bg-hover);
        border-radius: 6px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.6s ease-out;
      }

      /* USER COLORS */
      .user-jefferson {
        --u-color: #3b82f6;
      }
      .user-jesse {
        --u-color: #f59e0b;
      }
      .user-junior {
        --u-color: #10b981;
      }

      /* CONTENT */
      .content {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .toolbar {
        background: var(--bg-surface);
        padding: 1rem;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      /* Wrapper para input com ícone */
      .input-wrapper {
        position: relative;
        flex: 1;
        min-width: 200px;
      }
      .input-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        width: 18px;
        height: 18px;
        pointer-events: none;
      }

      .search-box {
        position: relative;
        flex: 1;
        min-width: 200px;
      }

      .search-input {
        width: 100%;
        padding: 12px 12px 12px 40px; /* Padding maior para toque */
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-body);
        color: var(--text-main);
        font-size: 0.95rem;
      }
      .search-input:focus {
        border-color: var(--primary);
        background: var(--bg-surface);
        box-shadow: 0 0 0 2px var(--primary-light);
      }

      .select-input {
        width: 100%;
        padding: 12px 30px 12px 40px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-body)
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E")
          no-repeat right 10px center;
        background-size: 16px;
        appearance: none;
        color: var(--text-main);
        cursor: pointer;
        font-size: 0.95rem;
      }

      /* CALENDAR GRID */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(280px, 1fr)
        ); /* Cards um pouco mais largos */
        gap: 20px;
      }

      .shift-card {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        position: relative;
        cursor: pointer;
        transition: var(--transition);
        animation: fadeUp 0.4s ease-out forwards;
        opacity: 0;
      }
      .shift-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
      }

      @keyframes fadeUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .shift-header {
        padding: 14px 18px;
        background: var(--bg-hover);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 0.95rem;
      }

      .shift-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 99px;
        text-transform: uppercase;
        font-weight: 700;
        white-space: nowrap;
        max-width: 140px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* NOVOS BADGES (Alto Contraste) */
      /* Light Mode Defaults */
      .badge-50 {
        background: #dbeafe;
        color: #172554;
        border: 1px solid #bfdbfe;
      }
      .badge-100 {
        background: #ffedd5;
        color: #7c2d12;
        border: 1px solid #fed7aa;
      }
      .badge-folga {
        background: #dcfce7;
        color: #14532d;
        border: 1px solid #bbf7d0;
      }
      .badge-normal {
        background: var(--bg-body);
        color: var(--text-muted);
        border: 1px solid var(--border);
      }
      .badge-today {
        background: var(--primary-light);
        color: var(--primary);
        border: 1px solid var(--primary);
      }

      /* Dark Mode Overrides for Badges */
      [data-theme="dark"] .badge-50 {
        background: #172554;
        color: #dbeafe;
        border-color: #1e3a8a;
      }
      [data-theme="dark"] .badge-100 {
        background: #431407;
        color: #ffedd5;
        border-color: #7c2d12;
      }
      [data-theme="dark"] .badge-folga {
        background: #052e16;
        color: #dcfce7;
        border-color: #14532d;
      }
      [data-theme="dark"] .badge-today {
        background: rgba(96, 165, 250, 0.2);
        color: #60a5fa;
        border-color: #60a5fa;
      }

      .shift-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 14px;
      }

      .avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: white;
        font-size: 1.4rem;
        box-shadow: var(--shadow-sm);
        position: relative;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); /* Melhor leitura */
      }

      .avatar::after {
        content: "";
        position: absolute;
        inset: -3px;
        border-radius: 50%;
        border: 2px solid var(--bg-surface);
        opacity: 0.5;
      }

      .shift-details {
        text-align: center;
      }
      .shift-name {
        font-weight: 700;
        font-size: 1.2rem;
      }
      .shift-date {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 2px;
      }

      /* --- MODAL --- */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7); /* Fundo mais escuro para foco */
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .modal-backdrop.active {
        opacity: 1;
        pointer-events: all;
      }

      .modal-content {
        background: var(--bg-surface);
        width: 100%;
        max-width: 450px;
        border-radius: 16px;
        padding: 24px;
        transform: scale(0.95);
        transition: transform 0.2s;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
      }
      .modal-backdrop.active .modal-content {
        transform: scale(1);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 1.35rem;
        font-weight: 700;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid var(--border);
      }

      /* --- HISTORICO LIST --- */
      .history-list {
        max-height: 300px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .history-item {
        background: var(--bg-hover);
        padding: 14px;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      .history-date {
        font-weight: 700;
        color: var(--primary);
        font-size: 0.95rem;
      }
      .history-details {
        margin-top: 10px;
        font-size: 0.9rem;
      }
      .history-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        border-bottom: 1px dashed var(--border);
        padding-bottom: 2px;
      }
      .history-row:last-child {
        border-bottom: none;
      }

      /* --- TOAST --- */
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: var(--bg-surface);
        padding: 16px 24px;
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        gap: 12px;
        border-left: 4px solid var(--primary);
        z-index: 2000;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        font-weight: 500;
        font-size: 0.95rem;
        border: 1px solid var(--border);
        border-left-width: 4px;
      }
      .toast-success {
        border-left-color: var(--success);
        color: var(--text-main);
      }
      .toast-warning {
        border-left-color: var(--warning);
        color: var(--text-main);
      }
      .toast-error {
        border-left-color: var(--danger);
        color: var(--text-main);
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* --- MOBILE --- */
      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
          padding: 1rem;
        }
        .top-nav {
          padding: 1rem;
        }
        .sidebar {
          order: -1;
        }
        .search-box {
          width: 100%;
          order: 3;
          margin-top: 8px;
        }
        .filters {
          display: flex;
          gap: 8px;
          width: 100%;
        }
        .filters select {
          flex: 1;
        }
        .btn-back-to-top {
          bottom: 20px;
          right: 20px;
        }
      }

      @media print {
        body {
          background: white;
          color: black;
        }
        .top-nav,
        .toolbar,
        .btn,
        .modal-backdrop,
        .toast,
        .btn-icon,
        .btn-back-to-top {
          display: none !important;
        }
        .dashboard {
          display: block;
          padding: 0;
        }
        .sidebar {
          display: none;
        }
        .calendar-grid {
          display: block;
        }
        .shift-card {
          border: 1px solid #ccc;
          page-break-inside: avoid;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          padding: 10px;
        }
        .shift-header {
          background: none;
          width: 150px;
          border-bottom: none;
        }
        .shift-body {
          flex-direction: row;
          padding: 0;
          gap: 20px;
        }
        .avatar {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-layout">
      <!-- HEADER -->
      <header class="top-nav">
        <div
          class="brand"
          onclick="app.resetFilters()"
          title="Voltar ao Início"
        >
          <div class="brand-icon">
            <svg
              width="24"
              height="24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div class="brand-info">
            <h1>Escala 2026</h1>
          </div>
        </div>
        <div class="nav-actions">
          <button class="btn btn-icon" id="themeToggle" title="Alternar Tema">
            <svg
              width="20"
              height="20"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>

          <div style="position: relative">
            <button
              class="btn btn-secondary"
              onclick="app.toggleMenu()"
              title="Opções"
              style="padding: 8px"
            >
              <svg
                width="20"
                height="20"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                ></path>
              </svg>
            </button>
            <div
              id="dropdownMenu"
              style="
                position: absolute;
                right: 0;
                top: 120%;
                background: var(--bg-surface);
                border: 1px solid var(--border);
                border-radius: 8px;
                width: 220px;
                display: none;
                flex-direction: column;
                box-shadow: var(--shadow-md);
                overflow: hidden;
                z-index: 10;
              "
            >
              <button
                class="btn"
                style="
                  width: 100%;
                  justify-content: flex-start;
                  border-radius: 0;
                  color: var(--text-muted);
                "
                onclick="app.exportCSV(); app.toggleMenu()"
              >
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                  ></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Exportar CSV
              </button>
              <button
                class="btn"
                style="
                  width: 100%;
                  justify-content: flex-start;
                  border-radius: 0;
                  color: var(--text-muted);
                "
                onclick="app.exportPDF(); app.toggleMenu()"
              >
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                  ></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                  <text x="8" y="19" font-size="6" fill="currentColor">
                    PDF
                  </text>
                </svg>
                Exportar PDF
              </button>
              <button
                class="btn"
                style="
                  width: 100%;
                  justify-content: flex-start;
                  border-radius: 0;
                  color: var(--text-muted);
                "
                onclick="app.saveMonthlyClosing(); app.toggleMenu()"
              >
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                  ></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                  <text
                    x="6"
                    y="18"
                    font-size="5"
                    fill="currentColor"
                    font-weight="bold"
                  >
                    $
                  </text>
                </svg>
                Salvar Fechamento
              </button>
              <button
                class="btn"
                style="
                  width: 100%;
                  justify-content: flex-start;
                  border-radius: 0;
                  color: var(--text-muted);
                "
                onclick="app.openHistoryModal(); app.toggleMenu()"
              >
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Ver Histórico
              </button>

              <div
                style="border-top: 1px solid var(--border); margin: 4px 0"
              ></div>
              <button
                class="btn"
                style="
                  width: 100%;
                  justify-content: flex-start;
                  border-radius: 0;
                  color: var(--text-muted);
                "
                onclick="app.backupData(); app.toggleMenu()"
              >
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                  ></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Backup JSON
              </button>
              <button
                class="btn"
                style="
                  width: 100%;
                  justify-content: flex-start;
                  border-radius: 0;
                  color: var(--text-muted);
                "
                onclick="document.getElementById('importFile').click(); app.toggleMenu()"
              >
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Restaurar Backup
              </button>
              <button
                class="btn"
                style="
                  width: 100%;
                  justify-content: flex-start;
                  border-radius: 0;
                  color: var(--text-muted);
                "
                onclick="window.print(); app.toggleMenu()"
              >
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <polyline points="6 9 6 2 18 2 18 9"></polyline>
                  <path
                    d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"
                  ></path>
                  <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Imprimir Página
              </button>
              <div
                style="border-top: 1px solid var(--border); margin: 4px 0"
              ></div>
              <button
                class="btn"
                style="
                  width: 100%;
                  justify-content: flex-start;
                  border-radius: 0;
                  color: var(--danger);
                "
                onclick="app.resetData(); app.toggleMenu()"
              >
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path d="M3 6h18"></path>
                  <path
                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                  ></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                Resetar Tudo
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- HIDDEN FILE INPUT -->
      <input
        type="file"
        id="importFile"
        style="display: none"
        accept=".json"
        onchange="app.importBackup(this)"
      />

      <!-- DASHBOARD -->
      <main class="dashboard">
        <!-- SIDEBAR STATS -->
        <aside class="sidebar">
          <div class="card">
            <div class="stats-header">
              <span>Distribuição Anual</span>
              <button
                class="btn btn-icon"
                id="btnToggleValues"
                onclick="app.toggleValues()"
                title="Ver valores estimados"
                style="
                  width: 28px;
                  height: 28px;
                  padding: 0;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
            </div>
            <div id="statsContainer"></div>
            <div
              style="
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px solid var(--border);
                font-size: 0.85rem;
                color: var(--text-muted);
              "
            >
              Total de plantões em 2026: <strong id="totalShifts">0</strong>
            </div>
          </div>

          <div
            id="nextShiftCard"
            class="card"
            style="
              background: linear-gradient(
                135deg,
                var(--primary),
                var(--primary-dark)
              );
              color: white;
              border: none;
              transition: background 0.5s ease;
            "
          >
            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px">
              Próximo Plantão
            </div>
            <div id="nextShiftInfo" style="font-size: 1.5rem; font-weight: 700">
              -
            </div>
            <div id="nextShiftDate" style="font-size: 0.9rem; opacity: 0.9">
              -
            </div>
          </div>
        </aside>

        <!-- MAIN CONTENT -->
        <section class="content">
          <div class="toolbar">
            <div class="input-wrapper">
              <svg
                class="input-icon"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="Buscar data ou nome..."
                onkeyup="app.filter()"
              />
            </div>

            <div class="filters" style="display: contents">
              <div class="input-wrapper">
                <svg
                  class="input-icon"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <select
                  id="monthFilter"
                  class="select-input"
                  onchange="app.filter()"
                >
                  <option value="all">Todo o Ano</option>
                  <option value="1">Janeiro</option>
                  <option value="2">Fevereiro</option>
                  <option value="3">Março</option>
                  <option value="4">Abril</option>
                  <option value="5">Maio</option>
                  <option value="6">Junho</option>
                  <option value="7">Julho</option>
                  <option value="8">Agosto</option>
                  <option value="9">Setembro</option>
                  <option value="10">Outubro</option>
                  <option value="11">Novembro</option>
                  <option value="12">Dezembro</option>
                </select>
              </div>

              <div class="input-wrapper">
                <svg
                  class="input-icon"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <select
                  id="personFilter"
                  class="select-input"
                  onchange="app.filter()"
                >
                  <option value="all">Todos</option>
                  <option value="Jefferson">Jefferson</option>
                  <option value="Jessé">Jessé</option>
                  <option value="Júnior">Júnior</option>
                </select>
              </div>
            </div>
          </div>

          <div id="gridContainer" class="calendar-grid"></div>
        </section>
      </main>
    </div>

    <!-- BACK TO TOP BUTTON -->
    <button
      id="btnBackToTop"
      class="btn-back-to-top"
      aria-label="Voltar ao topo"
      onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"
    >
      <svg
        width="24"
        height="24"
        fill="none"
        stroke="currentColor"
        stroke-width="2.5"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M5 15l7-7 7 7"
        ></path>
      </svg>
    </button>

    <!-- EDIT MODAL -->
    <div class="modal-backdrop" id="editModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Editar Plantão</h2>
          <button class="btn btn-icon" onclick="app.closeModal()">
            &times;
          </button>
        </div>

        <input type="hidden" id="editIndex" />

        <div style="display: flex; flex-direction: column; gap: 16px">
          <div>
            <label
              style="
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                font-size: 0.9rem;
              "
              >Data do Plantão</label
            >
            <input type="date" id="editDate" class="search-input" />
            <div
              style="
                font-size: 0.8rem;
                color: var(--text-muted);
                margin-top: 4px;
              "
            >
              Alterar a data fará uma troca com quem estiver no destino.
            </div>
          </div>

          <div>
            <label
              style="
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                font-size: 0.9rem;
              "
              >Colaborador</label
            >
            <select id="editName" class="select-input" style="width: 100%">
              <option value="Jefferson">Jefferson</option>
              <option value="Jessé">Jessé</option>
              <option value="Júnior">Júnior</option>
            </select>
          </div>

          <div>
            <label
              style="
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                font-size: 0.9rem;
              "
              >Tipo de Escala</label
            >
            <select id="editType" class="select-input" style="width: 100%">
              <option value="Sábado (50%)">Sábado (50%)</option>
              <option value="Domingo (100%)">Domingo (100%)</option>
              <option value="Feriado (100%)">Feriado (100%)</option>
              <option value="Ponto Facultativo (Folga)">
                Ponto Facultativo (Folga)
              </option>
            </select>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="app.closeModal()">
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="app.saveChanges()">
            Salvar Alterações
          </button>
        </div>
      </div>
    </div>

    <!-- NOVO: MODAL DE HISTÓRICO -->
    <div class="modal-backdrop" id="historyModal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h2>Histórico de Fechamentos</h2>
          <button class="btn btn-icon" onclick="app.closeHistoryModal()">
            &times;
          </button>
        </div>
        <div class="history-list" id="historyListContainer">
          <!-- Lista será renderizada aqui via JS -->
          <p style="text-align: center; color: var(--text-muted)">
            A carregar...
          </p>
        </div>
        <div class="modal-actions">
          <button class="btn btn-primary" onclick="app.closeHistoryModal()">
            Fechar
          </button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        setDoc,
        doc,
        query,
        orderBy,
        deleteDoc,
        getDoc,
        onSnapshot,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- COLE SUA CONFIGURAÇÃO DO FIREBASE AQUI ---
      const firebaseConfig = {
        apiKey: "AIzaSyDsyKD3JwVHfMqLNyfEBo1D35Eu9g8W60Y",
        authDomain: "escala-extraordinaria.firebaseapp.com",
        projectId: "escala-extraordinaria",
        storageBucket: "escala-extraordinaria.firebasestorage.app",
        messagingSenderId: "638653020070",
        appId: "1:638653020070:web:9956783bf5e8a984210167",
      };

      // Inicializar Firebase
      const fbApp = initializeApp(firebaseConfig);
      const db = getFirestore(fbApp);

      // --- UTILS ---
      const Utils = {
        formatDateDisplay: (dateStr) => {
          const [y, m, d] = dateStr.split("-");
          const date = new Date(y, m - 1, d);
          return new Intl.DateTimeFormat("pt-BR", {
            day: "numeric",
            month: "long",
            weekday: "long",
          }).format(date);
        },
        formatShortDate: (dateStr) => {
          const [y, m, d] = dateStr.split("-");
          const date = new Date(y, m - 1, d);
          return new Intl.DateTimeFormat("pt-BR", {
            day: "2-digit",
            month: "short",
          }).format(date);
        },
        formatMoney: (val) => {
          return new Intl.NumberFormat("pt-BR", {
            style: "currency",
            currency: "BRL",
          }).format(val);
        },
        normalize: (str) =>
          str
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase(),
        getLocalISODate: () => {
          const d = new Date();
          const offset = d.getTimezoneOffset() * 60000;
          return new Date(d - offset).toISOString().split("T")[0];
        },
        isToday: (dateStr) => {
          const todayStr = Utils.getLocalISODate();
          return dateStr === todayStr;
        },
        getBadgeClass: (type) => {
          if (type.includes("50%")) return "badge-50";
          if (type.includes("100%")) return "badge-100";
          if (type.includes("Folga")) return "badge-folga";
          return "badge-normal";
        },
        showToast: (msg, type = "success") => {
          const toast = document.createElement("div");
          toast.className = `toast toast-${type}`;
          toast.textContent = msg;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        },
      };

      // --- ICONS SVG (Mantidos para referência, mas desativados para usar o PNG estático) ---
      const ICONS = {
        light:
          "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%232563eb%22/><path stroke=%22white%22 stroke-width=%228%22 stroke-linecap=%22round%22 fill=%22none%22 d=%22M20 30h60v50H20zM35 15v25M65 15v25M20 50h60%22/></svg>",
        dark: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%230f172a%22/><path stroke=%22%23f8fafc%22 stroke-width=%228%22 stroke-linecap=%22round%22 fill=%22none%22 d=%22M20 30h60v50H20zM35 15v25M65 15v25M20 50h60%22/></svg>",
      };

      // --- DATA SERVICE (FIREBASE) ---
      const FirebaseDataService = {
        config: null,

        async getFinancialConfig() {
          try {
            const docRef = doc(db, "configuracoes", "calculo_horas");
            const docSnap = await getDoc(docRef);
            const defaultConfig = {
              divisor: 220,
              horas_plantao: 9,
              salarios: { Jefferson: 0, Jessé: 0, Júnior: 0 },
              multiplicadores: {
                "Sábado (50%)": 1.5,
                "Domingo (100%)": 2.0,
                "Feriado (100%)": 2.0,
                "Ponto Facultativo (Folga)": 0,
              },
            };

            if (docSnap.exists())
              return { ...defaultConfig, ...docSnap.data() };
            else return defaultConfig;
          } catch (e) {
            console.error("Erro ao buscar config financeira:", e);
            return {
              divisor: 220,
              horas_plantao: 9,
              salarios: {},
              multiplicadores: {},
            };
          }
        },

        subscribeToFinancialConfig(callback) {
          const docRef = doc(db, "configuracoes", "calculo_horas");
          const defaultConfig = {
            divisor: 220,
            horas_plantao: 9,
            salarios: { Jefferson: 0, Jessé: 0, Júnior: 0 },
            multiplicadores: {},
          };

          return onSnapshot(
            docRef,
            (docSnap) => {
              if (docSnap.exists()) {
                const newConfig = { ...defaultConfig, ...docSnap.data() };
                this.config = newConfig;
                callback(newConfig);
              } else {
                this.config = defaultConfig;
                callback(defaultConfig);
              }
            },
            (error) => console.error("Erro ao ouvir config:", error)
          );
        },

        subscribeToData(callback) {
          const q = query(collection(db, "plantoes"));
          return onSnapshot(
            q,
            (querySnapshot) => {
              if (querySnapshot.empty) {
                const newData = this.generate2026();
                this.save(newData);
                return;
              }
              const data = [];
              querySnapshot.forEach((doc) => data.push(doc.data()));
              const sortedData = data.sort((a, b) =>
                a.date.localeCompare(b.date)
              );
              callback(sortedData);
            },
            (error) => {
              console.error("Erro no listener:", error);
              Utils.showToast("Erro de conexão em tempo real.", "error");
            }
          );
        },

        // NOVO: Listener para Fechamentos Mensais
        subscribeToClosings(callback) {
          // Ordenar por ID (que é ano-mês, ex: 2026-01) decrescente para ver os mais recentes primeiro
          const q = query(collection(db, "fechamentos_mensais"));
          return onSnapshot(q, (querySnapshot) => {
            const data = [];
            querySnapshot.forEach((doc) => {
              data.push({ id: doc.id, ...doc.data() });
            });
            // Ordenar decrescente (mais recente primeiro)
            const sorted = data.sort((a, b) => b.id.localeCompare(a.id));
            callback(sorted);
          });
        },

        async save(fullDataList) {
          try {
            const promises = fullDataList.map((item) =>
              setDoc(doc(db, "plantoes", item.date), item)
            );
            await Promise.all(promises);
          } catch (e) {
            console.error("Erro ao salvar no Firebase:", e);
            Utils.showToast("Erro ao salvar no banco.", "error");
          }
        },

        async saveClosing(month, year, stats) {
          try {
            const id = `${year}-${String(month).padStart(2, "0")}`;
            await setDoc(doc(db, "fechamentos_mensais", id), {
              mes: parseInt(month),
              ano: parseInt(year),
              totais: stats,
              criado_em: serverTimestamp(),
            });
            Utils.showToast(`Fechamento de ${month}/${year} salvo!`, "success");
          } catch (e) {
            console.error("Erro ao salvar fechamento:", e);
            Utils.showToast("Erro ao salvar fechamento.", "error");
          }
        },

        async delete(dateStr) {
          try {
            await deleteDoc(doc(db, "plantoes", dateStr));
          } catch (e) {
            console.error("Erro ao deletar documento antigo:", e);
          }
        },

        generate2026() {
          const data = [];
          const staff = ["Jessé", "Júnior", "Jefferson"];
          let staffIdx = 0;
          let date = new Date(2026, 0, 1);
          while (date.getDay() !== 6) date.setDate(date.getDate() + 1);
          while (date.getFullYear() === 2026) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            data.push({
              date: `${y}-${m}-${d}`,
              name: staff[staffIdx],
              type: "Sábado (50%)",
            });
            date.setDate(date.getDate() + 7);
            staffIdx = (staffIdx + 1) % staff.length;
          }
          return data;
        },
      };

      // --- APP CONTROLLER ---
      const App = (() => {
        let state = [];
        let closings = []; // Estado para o histórico
        let showValues = false;

        const els = {
          grid: document.getElementById("gridContainer"),
          stats: document.getElementById("statsContainer"),
          total: document.getElementById("totalShifts"),
          nextInfo: document.getElementById("nextShiftInfo"),
          nextDate: document.getElementById("nextShiftDate"),
          nextCard: document.getElementById("nextShiftCard"),
          search: document.getElementById("searchInput"),
          filterM: document.getElementById("monthFilter"),
          filterP: document.getElementById("personFilter"),
          modal: document.getElementById("editModal"),
          historyModal: document.getElementById("historyModal"), // Novo modal
          historyList: document.getElementById("historyListContainer"), // Lista do histórico
          menu: document.getElementById("dropdownMenu"),
          toggleBtn: document.getElementById("btnToggleValues"),
        };

        function init() {
          FirebaseDataService.getFinancialConfig().then((config) => {
            FirebaseDataService.config = config;

            FirebaseDataService.subscribeToFinancialConfig((newConfig) => {
              render();
            });

            FirebaseDataService.subscribeToData((data) => {
              state = data;
              if (!document.body.hasAttribute("data-ready")) {
                setupTheme();
                setupScrollToTop();
                document.body.setAttribute("data-ready", "true");
              }
              render();
            });

            // Escutar Histórico
            FirebaseDataService.subscribeToClosings((data) => {
              closings = data;
              renderHistory(); // Atualiza a lista se o modal estiver aberto (ou para quando abrir)
            });
          });

          document.addEventListener("click", (e) => {
            if (!e.target.closest(".nav-actions"))
              els.menu.style.display = "none";
          });
        }

        // --- ICONS UPDATE ---
        function updateIcons(theme) {
          const iconHref = theme === "dark" ? ICONS.dark : ICONS.light;
          document.getElementById("faviconLink").href = iconHref; // Desativado para manter o PNG
          document.getElementById("appleIconLink").href = iconHref;
          // Removido a atualização automática do appleIconLink para manter o PNG estático
        }

        function setupTheme() {
          const savedTheme = localStorage.getItem("theme") || "light";
          document.documentElement.setAttribute("data-theme", savedTheme);
          updateIcons(savedTheme); // Initialize icons

          document
            .getElementById("themeToggle")
            .addEventListener("click", () => {
              const current =
                document.documentElement.getAttribute("data-theme");
              const next = current === "light" ? "dark" : "light";
              document.documentElement.setAttribute("data-theme", next);
              localStorage.setItem("theme", next);
              updateIcons(next); // Update icons on toggle
            });
        }

        function setupScrollToTop() {
          const btn = document.getElementById("btnBackToTop");
          window.addEventListener("scroll", () => {
            if (window.scrollY > 300) btn.classList.add("visible");
            else btn.classList.remove("visible");
          });
        }

        function toggleValues() {
          showValues = !showValues;
          const btn = document.getElementById("btnToggleValues");
          if (showValues) {
            btn.innerHTML = `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;
            btn.title = "Ocultar valores estimados";
            btn.style.color = "var(--primary)";
          } else {
            btn.innerHTML = `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
            btn.title = "Ver valores estimados";
            btn.style.color = "var(--text-muted)";
          }
          render();
        }

        function toggleMenu() {
          const display = els.menu.style.display;
          els.menu.style.display = display === "flex" ? "none" : "flex";
        }

        function resetFilters() {
          els.search.value = "";
          els.filterM.value = "all";
          els.filterP.value = "all";
          render();
        }

        function createPDFDoc() {
          if (!window.jspdf) {
            Utils.showToast("Erro: Biblioteca PDF não carregada.", "error");
            return null;
          }
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          const headers = [["Data", "Dia", "Colaborador", "Tipo"]];
          const dataToExport = [...state].sort((a, b) =>
            a.date.localeCompare(b.date)
          );

          const rows = dataToExport.map((item) => {
            const [y, m, d] = item.date.split("-");
            const dateObj = new Date(y, m - 1, d);
            const dateFmt = `${d}/${m}/${y}`;
            const weekDay = new Intl.DateTimeFormat("pt-BR", {
              weekday: "long",
            }).format(dateObj);
            const weekDayCap =
              weekDay.charAt(0).toUpperCase() + weekDay.slice(1);
            return [dateFmt, weekDayCap, item.name, item.type];
          });

          doc.setFontSize(18);
          doc.text("Escala 2026", 14, 22);
          doc.setFontSize(11);
          doc.text("Relatório de Plantões", 14, 30);

          doc.autoTable({
            startY: 36,
            head: headers,
            body: rows,
            headStyles: { fillColor: [59, 130, 246] },
            alternateRowStyles: { fillColor: [240, 249, 255] },
            margin: { top: 30 },
          });
          return doc;
        }

        function exportPDF() {
          const doc = createPDFDoc();
          if (doc) doc.save("escala_2026.pdf");
        }

        function calculateStats(dataList) {
          const counts = {};
          const values = {};
          ["Jefferson", "Jessé", "Júnior"].forEach((n) => {
            counts[n] = 0;
            values[n] = 0;
          });

          const config = FirebaseDataService.config || {
            horas_plantao: 0,
            divisor: 1,
            salarios: {},
            multiplicadores: {},
          };

          dataList.forEach((item) => {
            counts[item.name] = (counts[item.name] || 0) + 1;
            const salary = config.salarios?.[item.name] || 0;
            const hourlyRate = salary / (config.divisor || 1);
            let multiplier = config.multiplicadores?.[item.type];

            if (multiplier === undefined) {
              if (item.type.includes("50%")) multiplier = 1.5;
              else if (item.type.includes("100%")) multiplier = 2.0;
              else multiplier = 0;
            }
            const shiftValue =
              hourlyRate * multiplier * (config.horas_plantao || 0);
            values[item.name] += shiftValue;
          });

          return { counts, values, total: dataList.length };
        }

        function saveMonthlyClosing() {
          const monthVal = els.filterM.value;
          if (monthVal === "all") {
            alert(
              "Por favor, selecione um mês específico no filtro para salvar o fechamento."
            );
            return;
          }
          const monthData = state.filter((item) => {
            const [y, m, d] = item.date.split("-");
            return parseInt(m) === parseInt(monthVal);
          });
          if (monthData.length === 0) {
            alert("Não há dados para o mês selecionado.");
            return;
          }
          const stats = calculateStats(monthData);
          const year = 2026;
          FirebaseDataService.saveClosing(monthVal, year, stats.values);
        }

        // --- HISTÓRICO ---
        function openHistoryModal() {
          renderHistory();
          els.historyModal.classList.add("active");
        }

        function closeHistoryModal() {
          els.historyModal.classList.remove("active");
        }

        function renderHistory() {
          if (closings.length === 0) {
            els.historyList.innerHTML = `<p style="text-align:center; color:var(--text-muted);">Nenhum fechamento salvo.</p>`;
            return;
          }

          els.historyList.innerHTML = closings
            .map((c) => {
              const totalGeral = Object.values(c.totais || {}).reduce(
                (a, b) => a + b,
                0
              );
              const monthName = new Date(c.ano, c.mes - 1).toLocaleDateString(
                "pt-BR",
                { month: "long", year: "numeric" }
              );

              const details = Object.entries(c.totais || {})
                .map(
                  ([name, val]) =>
                    `<div class="history-row"><span>${name}</span><strong>${Utils.formatMoney(
                      val
                    )}</strong></div>`
                )
                .join("");

              return `
                   <div class="history-item">
                      <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                         <span class="history-date">${
                           monthName.charAt(0).toUpperCase() +
                           monthName.slice(1)
                         }</span>
                         <span style="font-size:0.8rem; color:var(--text-muted)">Salvo em: ${
                           c.criado_em
                             ? new Date(
                                 c.criado_em.seconds * 1000
                               ).toLocaleDateString()
                             : "Hoje"
                         }</span>
                      </div>
                      <div class="history-details">${details}</div>
                   </div>
                `;
            })
            .join("");
        }

        // ... [Resto da lógica de renderização e modal igual] ...

        function render() {
          renderGrid();
          renderNextShift();
        }

        function renderGrid() {
          const term = els.search.value.toLowerCase();
          const monthVal = els.filterM.value;
          const personVal = els.filterP.value;

          const filtered = state
            .map((item, idx) => ({ ...item, originalIdx: idx }))
            .filter((item) => {
              const [y, m, d] = item.date.split("-");
              const matchesMonth =
                monthVal === "all" || parseInt(m) === parseInt(monthVal);
              const matchesPerson =
                personVal === "all" || item.name === personVal;
              const matchesSearch =
                item.name.toLowerCase().includes(term) ||
                item.date.includes(term);
              return matchesMonth && matchesPerson && matchesSearch;
            });

          const stats = calculateStats(filtered);
          renderStatsUI(stats);

          els.grid.innerHTML = filtered
            .map((item, i) => {
              const isToday = Utils.isToday(item.date);
              const userClass = `user-${Utils.normalize(item.name)}`;
              const badgeClass = Utils.getBadgeClass(item.type);

              return `
              <div class="shift-card" style="animation-delay: ${Math.min(
                i * 0.03,
                0.5
              )}s" onclick="app.openModal(${item.originalIdx})">
                <div class="shift-header">
                  <span style="color: var(--text-muted)">${Utils.formatShortDate(
                    item.date
                  )}</span>
                  <span class="shift-badge ${
                    isToday ? "badge-today" : badgeClass
                  }">
                    ${isToday ? "Hoje" : item.type}
                  </span>
                </div>
                <div class="shift-body">
                  <div class="avatar ${userClass}" style="background: var(--u-color)">
                    ${item.name.charAt(0)}
                  </div>
                  <div class="shift-details">
                    <div class="shift-name">${item.name}</div>
                    <div class="shift-date">${Utils.formatDateDisplay(
                      item.date
                    )}</div>
                  </div>
                </div>
              </div>
            `;
            })
            .join("");
        }

        function renderStatsUI({ counts, values, total }) {
          els.total.textContent = total;
          els.stats.innerHTML = Object.entries(counts)
            .map(([name, count]) => {
              const percent =
                total > 0 ? ((count / total) * 100).toFixed(1) : 0;
              const colorVar = `var(--u-color)`;
              const userClass = `user-${Utils.normalize(name)}`;
              const money = values[name] || 0;

              const valueHtml = showValues
                ? `<div class="stat-value visible"><span>Valor Estimado:</span><span>${Utils.formatMoney(
                    money
                  )}</span></div>`
                : `<div class="stat-value"><span>Valor Estimado:</span><span>${Utils.formatMoney(
                    money
                  )}</span></div>`;

              return `
              <div class="stat-item ${userClass}">
                <div class="stat-row">
                  <span>${name}</span>
                  <strong>${count} <span style="font-size:0.8em; opacity:0.7">(${percent}%)</span></strong>
                </div>
                <div class="progress-bg">
                  <div class="progress-fill" style="width: ${percent}%; background: ${colorVar}"></div>
                </div>
                ${valueHtml}
              </div>
            `;
            })
            .join("");
        }

        function renderNextShift() {
          const todayStr = Utils.getLocalISODate(); // Data atual YYYY-MM-DD
          const currentHour = new Date().getHours(); // Hora atual (0-23)

          // Lógica atualizada: Próximo plantão muda após as 17h do dia do plantão atual
          const next = state.find((item) => {
            // Se for data futura, é candidato
            if (item.date > todayStr) return true;

            // Se for hoje, só mostra se for ANTES das 17h
            if (item.date === todayStr) {
              return currentHour < 17;
            }

            // Datas passadas são ignoradas
            return false;
          });

          if (next) {
            els.nextInfo.textContent = next.name;
            els.nextDate.textContent = Utils.formatShortDate(next.date);
            const nameNorm = Utils.normalize(next.name);
            let gradient =
              "linear-gradient(135deg, var(--primary), var(--primary-dark))";
            if (nameNorm === "jesse")
              gradient = "linear-gradient(135deg, #f59e0b, #b45309)";
            else if (nameNorm === "junior")
              gradient = "linear-gradient(135deg, #10b981, #047857)";
            else gradient = "linear-gradient(135deg, #3b82f6, #1d4ed8)";
            els.nextCard.style.background = gradient;
          } else {
            els.nextInfo.textContent = "Concluído";
            els.nextDate.textContent = "2026";
            els.nextCard.style.background =
              "linear-gradient(135deg, #64748b, #0f172a)";
          }
        }

        function openModal(idx) {
          const item = state[idx];
          document.getElementById("editIndex").value = idx;
          document.getElementById("editDate").value = item.date;
          document.getElementById("editName").value = item.name;
          document.getElementById("editType").value =
            item.type || "Sábado (50%)";
          els.modal.classList.add("active");
        }

        function closeModal() {
          els.modal.classList.remove("active");
        }

        function saveChanges() {
          const idx = parseInt(document.getElementById("editIndex").value);
          const newDate = document.getElementById("editDate").value;
          const newName = document.getElementById("editName").value;
          const newType = document.getElementById("editType").value;

          if (!newDate) return Utils.showToast("Data inválida", "error");

          const currentItem = state[idx];
          const oldDate = currentItem.date;

          if (newDate !== oldDate) {
            const conflictIdx = state.findIndex((i) => i.date === newDate);
            if (conflictIdx !== -1) {
              if (
                !confirm(
                  `A data ${newDate} já está ocupada por ${state[conflictIdx].name}. Deseja trocar?`
                )
              ) {
                return;
              }
              state[conflictIdx].date = oldDate;
              FirebaseDataService.save([state[conflictIdx]]);
              Utils.showToast("Troca de plantão realizada!", "warning");
            } else {
              FirebaseDataService.delete(oldDate);
            }
          }

          state[idx] = { date: newDate, name: newName, type: newType };
          FirebaseDataService.save([state[idx]]);
          render();
          closeModal();
          if (newDate === oldDate)
            Utils.showToast("Alterações salvas com sucesso!", "success");
        }

        function backupData() {
          const dataStr =
            "data:text/json;charset=utf-8," +
            encodeURIComponent(JSON.stringify(state));
          const el = document.createElement("a");
          el.setAttribute("href", dataStr);
          el.setAttribute("download", "backup_escala_2026.json");
          document.body.appendChild(el);
          el.click();
          el.remove();
        }

        function importBackup(input) {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const json = JSON.parse(e.target.result);
              if (
                Array.isArray(json) &&
                json.length > 0 &&
                json[0].date &&
                json[0].name
              ) {
                state = json;
                FirebaseDataService.save(state);
                render();
                Utils.showToast("Backup restaurado com sucesso!", "success");
              } else {
                Utils.showToast("Arquivo de backup inválido.", "error");
              }
            } catch (err) {
              Utils.showToast("Erro ao ler arquivo JSON.", "error");
            }
          };
          reader.readAsText(file);
          input.value = "";
        }

        function exportCSV() {
          let csvContent = "data:text/csv;charset=utf-8,Data,Nome,Tipo\n";
          state.forEach((row) => {
            csvContent += `${row.date},${row.name},${row.type}\n`;
          });
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "escala_2026.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        function resetData() {
          if (
            confirm(
              "ATENÇÃO: Isso apagará todas as edições manuais e restaurará a escala original. Continuar?"
            )
          ) {
            const defaultData = FirebaseDataService.generate2026();
            state = defaultData;
            FirebaseDataService.save(state);
            render();
            Utils.showToast("Escala resetada para o padrão.", "success");
          }
        }

        return {
          init,
          filter: render,
          openModal,
          closeModal,
          closeHistoryModal,
          openHistoryModal,
          saveChanges,
          backupData,
          importBackup,
          exportCSV,
          exportPDF,
          saveMonthlyClosing,
          resetData,
          toggleMenu,
          toggleValues,
          resetFilters,
        };
      })();

      window.app = App;
      document.addEventListener("DOMContentLoaded", App.init);
    </script>
  </body>
</html>
